<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline';">
  <title>Business Registration Assistant</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: Arial, sans-serif;
      width: 100%;
      height: 100vh;
      color: #333;
      overflow-x: hidden;
    }

    .container {
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    /* User Navigation Header */
    .user-nav-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: #f5f7fa;
      border-bottom: 1px solid #e0e0e0;
      padding: 6px 12px;
      flex-shrink: 0;
      height: 36px;
    }

    .nav-button {
      background-color: transparent;
      color: #555;
      border: none;
      padding: 4px 8px;
      font-size: 12px;
      border-radius: 3px;
      cursor: pointer;
    }

    .nav-button:hover {
      background-color: #e8e8e8;
      color: #333;
    }

    .user-button {
      font-weight: bold;
      color: #2e5cb8;
    }

    /* Main Header */
    header {
      background-color: #2e5cb8;
      color: white;
      padding: 8px 12px;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: flex-end;
    }

    .status {
      display: flex;
      align-items: center;
    }

    #status-indicator {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background-color: #ccc;
      margin-right: 8px;
    }

    #status-indicator.active {
      background-color: #4caf50;
    }

    #status-indicator.warning {
      background-color: #ff9800;
    }

    /* Views */
    .view {
      padding: 15px;
      background-color: #f5f7fa;
      flex-grow: 0;
      overflow-y: auto;
      max-height: 50%;
      min-height: 100px;
    }

    .hidden {
      display: none;
    }

    /* No detection view */
    #no-detection {
      text-align: center;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }

    #no-detection p {
      margin-bottom: 12px;
      color: #666;
    }

    button {
      background-color: #2e5cb8;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
    }

    button:hover {
      background-color: #1c4ca9;
    }

    /* Detection view */
    .info-card {
      background-color: white;
      border-radius: 6px;
      padding: 12px;
      margin-bottom: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .info-row {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
    }

    .label {
      font-weight: bold;
      width: 80px;
      color: #666;
    }

    .meter {
      height: 12px;
      background-color: #eee;
      border-radius: 6px;
      overflow: hidden;
      flex: 1;
      margin: 0 8px;
    }

    #confidence-bar {
      height: 100%;
      width: 0%;
      background-color: #4caf50;
    }

    h2 {
      font-size: 14px;
      margin-bottom: 10px;
      color: #2e5cb8;
    }

    .action-button {
      width: 100%;
      text-align: left;
      margin-bottom: 8px;
      padding: 8px 10px;
      background-color: white;
      color: #333;
      border: 1px solid #ddd;
    }

    .action-button:hover {
      background-color: #f5f5f5;
    }

    /* Chat section */
    .chat-section {
      display: flex;
      flex-direction: column;
      background-color: #f5f7fa;
      flex-grow: 1;
      border-top: 1px solid #ddd;
      height: 50%;
      min-height: 200px;
    }

    .chat-header {
      padding: 10px 15px;
      background-color: #eee;
      border-bottom: 1px solid #ddd;
      font-size: 14px;
      color: #333;
    }

    .chat-messages {
      flex-grow: 1;
      overflow-y: auto;
      padding: 15px;
      display: flex;
      flex-direction: column;
    }

    .message {
      max-width: 80%;
      padding: 8px 12px;
      margin-bottom: 10px;
      border-radius: 12px;
      font-size: 13px;
      line-height: 1.4;
    }

    .message.system {
      background-color: #e6f2ff;
      align-self: flex-start;
      border-bottom-left-radius: 2px;
    }

    .message.user {
      background-color: #dcf8c6;
      align-self: flex-end;
      border-bottom-right-radius: 2px;
    }

    .chat-input-form {
      display: flex;
      padding: 10px;
      border-top: 1px solid #ddd;
      background-color: white;
    }

    #chat-input {
      flex-grow: 1;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 16px;
      font-size: 13px;
      margin-right: 8px;
    }

    #chat-submit {
      padding: 6px 12px;
      font-size: 13px;
    }

    /* Footer */
    footer {
      padding: 8px;
      text-align: center;
      font-size: 12px;
      color: #666;
      border-top: 1px solid #eee;
      flex-shrink: 0;
    }

    /* Error message styles */
    .error-container {
      background-color: #fee;
      border: 1px solid #f88;
      color: #800;
      padding: 12px;
      margin: 8px;
      border-radius: 4px;
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- User Navigation Header -->
    <div class="user-nav-header">
      <button id="endeavors-button" class="nav-button">My Endeavors</button>
      <button id="user-button" class="nav-button user-button">USER</button>
    </div>
    
    <header>
      <div class="status">
        <span id="status-indicator"></span>
        <span id="status-text">Checking...</span>
      </div>
    </header>
    
    <div id="error-container" class="error-container"></div>
    
    <div id="no-detection" class="view">
      <p>No business registration form detected on this page.</p>
      <button id="check-again">Check Again</button>
    </div>
    
    <div id="detection" class="view hidden">
      <div class="info-card">
        <div class="info-row">
          <span class="label">State:</span>
          <span id="state-value">--</span>
        </div>
        <div class="info-row">
          <span class="label">Confidence:</span>
          <div class="meter">
            <div id="confidence-bar"></div>
          </div>
          <span id="confidence-value">0%</span>
        </div>
      </div>
      
      <div class="info-card">
        <h2>Form Assistance</h2>
        <button class="action-button">Auto-Fill Common Fields</button>
        <button class="action-button">Get Field Explanations</button>
        <button class="action-button">State Requirements</button>
      </div>
    </div>
    
    <!-- Chat Interface -->
    <div id="chat-container" class="chat-section">
      <h2 class="chat-header">Registration Assistant</h2>
      <div id="chat-messages" class="chat-messages">
        <div class="message system">
          Hello! I'm your business registration assistant. How can I help you today?
        </div>
      </div>
      <form id="chat-form" class="chat-input-form">
        <input type="text" id="chat-input" placeholder="Type your question here..." />
        <button type="submit" id="chat-submit">Send</button>
      </form>
    </div>
    
    <footer>
      <div>Business Registration Assistant v0.1</div>
    </footer>
  </div>
  
  <script>
    // DOM elements - Navigation
    const endeavorsButton = document.getElementById('endeavors-button');
    const userButton = document.getElementById('user-button');
    
    // DOM elements - Detection
    const statusIndicator = document.getElementById('status-indicator');
    const statusText = document.getElementById('status-text');
    const noDetectionView = document.getElementById('no-detection');
    const detectionView = document.getElementById('detection');
    const stateValue = document.getElementById('state-value');
    const confidenceBar = document.getElementById('confidence-bar');
    const confidenceValue = document.getElementById('confidence-value');
    const checkAgainButton = document.getElementById('check-again');
    const errorContainer = document.getElementById('error-container');
    
    // DOM elements - Chat
    const chatForm = document.getElementById('chat-form');
    const chatInput = document.getElementById('chat-input');
    const chatMessages = document.getElementById('chat-messages');
    
    // Show error message
    function showError(message) {
      errorContainer.textContent = message;
      errorContainer.style.display = 'block';
    }
    
    // Hide error message
    function hideError() {
      errorContainer.style.display = 'none';
    }
    
    // Initialize when panel opens
    document.addEventListener('DOMContentLoaded', function() {
      console.log('[BRA] Panel opened');
      
      try {
        // Get current tab
        chrome.tabs.query({active: true, currentWindow: true}, function(tabs) {
          if (tabs && tabs[0]) {
            // Get detection for current tab
            getDetectionResult(tabs[0].id);
          }
        });
        
        // Set up Check Again button
        checkAgainButton.addEventListener('click', function() {
          statusText.textContent = 'Checking...';
          hideError();
          
          chrome.tabs.query({active: true, currentWindow: true}, function(tabs) {
            if (tabs && tabs[0]) {
              // Ask content script to run detection
              try {
                chrome.tabs.sendMessage(tabs[0].id, {
                  action: 'triggerDetection'
                }, function(response) {
                  if (chrome.runtime.lastError) {
                    showError('Error connecting to page: ' + chrome.runtime.lastError.message);
                    return;
                  }
                  
                  // Wait a moment for detection to finish
                  setTimeout(function() {
                    getDetectionResult(tabs[0].id);
                  }, 500);
                });
              } catch (error) {
                showError('Error triggering detection: ' + error.message);
              }
            }
          });
        });
        
        // Set up chat form submission
        chatForm.addEventListener('submit', function(e) {
          e.preventDefault();
          
          const message = chatInput.value.trim();
          if (!message) return;
          
          // Add user message to chat
          addChatMessage(message, 'user');
          
          // Clear input
          chatInput.value = '';
          
          // Process the message and respond
          processUserMessage(message);
        });
        
        // Set up navigation buttons
        endeavorsButton.addEventListener('click', function() {
          console.log('[BRA] My Endeavors button clicked');
          // Currently just a placeholder - no functionality yet
        });
        
        userButton.addEventListener('click', function() {
          console.log('[BRA] User button clicked');
          // Currently just a placeholder - no functionality yet
        });
      } catch (error) {
        showError('Initialization error: ' + error.message);
      }
    });
    
    // Get detection result from background script
    function getDetectionResult(tabId) {
      try {
        chrome.runtime.sendMessage({
          action: 'getDetectionResult',
          tabId: tabId
        }, function(response) {
          if (chrome.runtime.lastError) {
            showError('Error getting detection result: ' + chrome.runtime.lastError.message);
            return;
          }
          
          if (response && response.success && response.result) {
            // Show detection result
            updateUI(response.result);
            hideError();
          } else {
            // Try asking content script directly
            askContentScript(tabId);
          }
        });
      } catch (error) {
        showError('Error communicating with background: ' + error.message);
      }
    }
    
    // Ask content script for results if background doesn't have them
    function askContentScript(tabId) {
      try {
        chrome.tabs.sendMessage(tabId, {
          action: 'getDetectionResult'
        }, function(result) {
          if (chrome.runtime.lastError) {
            // Content script not available
            showNoDetection();
            showError('Cannot connect to page: ' + chrome.runtime.lastError.message);
            return;
          }
          
          if (result) {
            updateUI(result);
            hideError();
          } else {
            showNoDetection();
          }
        });
      } catch (error) {
        showError('Error communicating with page: ' + error.message);
        showNoDetection();
      }
    }
    
    // Update UI with detection result
    function updateUI(result) {
      if (!result || !result.isBusinessRegistrationForm) {
        showNoDetection();
        return;
      }
      
      // Show detection view
      noDetectionView.classList.add('hidden');
      detectionView.classList.remove('hidden');
      
      // Update status indicator
      statusIndicator.classList.add('active');
      statusText.textContent = 'Business form detected';
      
      // Update state
      stateValue.textContent = result.state ? getStateName(result.state) : 'Unknown';
      
      // Update confidence
      const confidence = result.confidenceScore;
      confidenceBar.style.width = Math.min(confidence, 100) + '%';
      confidenceValue.textContent = confidence + '%';
    }
    
    // Show no detection view
    function showNoDetection() {
      statusIndicator.classList.remove('active');
      statusText.textContent = 'No detection';
      
      noDetectionView.classList.remove('hidden');
      detectionView.classList.add('hidden');
    }
    
    // Get full state name
    function getStateName(code) {
      const states = {
        'AL': 'Alabama', 'AK': 'Alaska', 'AZ': 'Arizona', 'AR': 'Arkansas',
        'CA': 'California', 'CO': 'Colorado', 'CT': 'Connecticut', 'DE': 'Delaware',
        'FL': 'Florida', 'GA': 'Georgia', 'HI': 'Hawaii', 'ID': 'Idaho',
        'IL': 'Illinois', 'IN': 'Indiana', 'IA': 'Iowa', 'KS': 'Kansas',
        'KY': 'Kentucky', 'LA': 'Louisiana', 'ME': 'Maine', 'MD': 'Maryland',
        'MA': 'Massachusetts', 'MI': 'Michigan', 'MN': 'Minnesota', 'MS': 'Mississippi',
        'MO': 'Missouri', 'MT': 'Montana', 'NE': 'Nebraska', 'NV': 'Nevada',
        'NH': 'New Hampshire', 'NJ': 'New Jersey', 'NM': 'New Mexico', 'NY': 'New York',
        'NC': 'North Carolina', 'ND': 'North Dakota', 'OH': 'Ohio', 'OK': 'Oklahoma',
        'OR': 'Oregon', 'PA': 'Pennsylvania', 'RI': 'Rhode Island', 'SC': 'South Carolina',
        'SD': 'South Dakota', 'TN': 'Tennessee', 'TX': 'Texas', 'UT': 'Utah',
        'VT': 'Vermont', 'VA': 'Virginia', 'WA': 'Washington', 'WV': 'West Virginia',
        'WI': 'Wisconsin', 'WY': 'Wyoming', 'DC': 'District of Columbia'
      };
      
      return states[code] || code;
    }
    
    // Chat Functions
    
    // Add a message to the chat
    function addChatMessage(text, type) {
      const messageDiv = document.createElement('div');
      messageDiv.classList.add('message', type);
      messageDiv.textContent = text;
      
      chatMessages.appendChild(messageDiv);
      
      // Scroll to bottom
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    // Process user message and generate response
    function processUserMessage(message) {
      // Simple response logic for now
      setTimeout(() => {
        let response;
        
        // Basic keyword matching
        if (message.toLowerCase().includes('help')) {
          response = "I can help you with business registration questions. What specifically would you like to know?";
        } 
        else if (message.toLowerCase().includes('llc')) {
          response = "An LLC (Limited Liability Company) is a business structure that combines pass-through taxation with limited liability protection.";
        }
        else if (message.toLowerCase().includes('corporation')) {
          response = "A corporation is a legal entity that is separate and distinct from its owners, offering limited liability protection but with more complex taxation.";
        }
        else if (message.toLowerCase().includes('cost') || message.toLowerCase().includes('fee')) {
          response = "Registration fees vary by state and business type. The base filing fee can range from $40 to $500, with additional fees for expedited processing.";
        }
        else if (message.toLowerCase().includes('time') || message.toLowerCase().includes('long')) {
          response = "Processing times vary by state. Standard processing typically takes 5-10 business days, while expedited options may be available for an additional fee.";
        }
        else {
          response = "I'm a simple assistant at the moment. Try asking about LLCs, corporations, registration fees, or processing times.";
        }
        
        addChatMessage(response, 'system');
      }, 600);
    }
  </script>
</body>
</html>